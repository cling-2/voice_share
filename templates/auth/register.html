{% extends "layout.html" %}
{% block title %}{{ '管理员' if page == 'admin' else '用户' }}注册{% endblock %}

{% block content %}
<div class="auth-container" style="display: flex; justify-content: center; padding-top: 2rem;">
  <section class="auth-card" style="width: 100%; max-width: 420px;">

    <div class="auth-header" style="text-align: center; margin-bottom: 2rem;">
      <div class="auth-icon" style="font-size: 3rem; color: var(--brand); margin-bottom: 0.5rem;">
        <i class="ri-user-add-line"></i>
      </div>
      <h1 style="font-size: 1.5rem; margin: 0; color: var(--text);">
        {{ '管理员入驻' if page == 'admin' else '创建新账号' }}
      </h1>
      <p style="color: var(--muted); margin-top: 0.5rem; font-size: 0.9rem;">
        {{ '加入管理团队，维护社区秩序' if page == 'admin' else '开启你的音乐分享之旅' }}
      </p>
    </div>

    <form method="post" class="modern-form">
      {{ form.hidden_tag() }}

      <div class="form-group" style="margin-bottom: 1.2rem;">
        <label class="form-label" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; display: block;">
          <i class="ri-user-line" style="color: var(--muted); margin-right: 4px;"></i> {{ form.username.label }}
        </label>
        {{ form.username(class="input", placeholder="4-32 位字母/数字/下划线") }}
        {% for error in form.username.errors %}
          <div class="error-msg" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.25rem;">
            <i class="ri-error-warning-fill"></i> {{ error }}
          </div>
        {% endfor %}
      </div>

      {% if form.role.type != 'HiddenField' %}
        <div class="form-group" style="margin-bottom: 1.2rem;">
          <label class="form-label" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; display: block;">
            <i class="ri-shield-user-line" style="color: var(--muted); margin-right: 4px;"></i> {{ form.role.label }}
          </label>
          {{ form.role(class="input", id="role-select", onchange="toggleSecretKey()", style="cursor: pointer;") }}
        </div>
      {% else %}
        {{ form.role() }}
      {% endif %}
      {% for error in form.role.errors %}
        <div class="error-msg">{{ error }}</div>
      {% endfor %}

      <div id="secret-key-group" style="display: none; margin-bottom: 1.2rem; background: #f8fafc; padding: 1rem; border-radius: 12px; border: 1px dashed #e2e8f0;">
        <label class="form-label" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; display: block; color: var(--brand);">
          <i class="ri-key-2-line" style="margin-right: 4px;"></i> {{ form.secret_key.label }}
        </label>
        {{ form.secret_key(class="input", placeholder="请输入内部认证密钥") }}

        <div style="display: flex; align-items: flex-start; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem; color: var(--muted);">
          <i class="ri-information-line" style="margin-top: 2px;"></i>
          <span>为了确保社区安全，注册管理员账号需要验证身份密钥。</span>
        </div>

        {% for error in form.secret_key.errors %}
          <div class="error-msg" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.25rem;">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="form-group" style="margin-bottom: 1.2rem;">
        <label class="form-label" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; display: block;">
          <i class="ri-lock-password-line" style="color: var(--muted); margin-right: 4px;"></i> {{ form.password.label }}
        </label>
        {{ form.password(class="input", placeholder="6-64 位，建议包含字母与数字") }}
        {% for error in form.password.errors %}
          <div class="error-msg" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.25rem;">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="form-group" style="margin-bottom: 1.5rem;">
        <label class="form-label" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; display: block;">
          <i class="ri-lock-check-line" style="color: var(--muted); margin-right: 4px;"></i> {{ form.confirm_password.label }}
        </label>
        {{ form.confirm_password(class="input", placeholder="再次输入上方密码") }}
        {% for error in form.confirm_password.errors %}
          <div class="error-msg" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.25rem;">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="form-group" style="margin-bottom: 1.5rem;">
        <div class="slider-verify" data-target="{{ form.slider_token.id }}">
          <div class="slider-track">
            <div class="slider-thumb">↔</div>
            <span class="slider-tip">按住滑块拖动到最右边</span>
          </div>
        </div>
        {% for error in form.slider_token.errors %}
          <div class="error-msg" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.25rem; text-align: center;">
            {{ error }}
          </div>
        {% endfor %}
      </div>

      <button type="submit" class="primary-btn" style="width: 100%; display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 0.8rem;">
        <span>立即注册</span> <i class="ri-arrow-right-line"></i>
      </button>

      <div style="text-align: center; margin-top: 1.5rem; font-size: 0.9rem;">
        <span style="color: var(--muted);">已有账号？</span>
        <a href="{{ url_for('auth.login') }}" style="color: var(--brand); font-weight: 600; text-decoration: none;">直接登录</a>
      </div>

    </form>
  </section>
</div>

<script>
function toggleSecretKey() {
  const roleSelect = document.getElementById('role-select');
  const secretGroup = document.getElementById('secret-key-group');

  // 如果存在下拉框，且选中值为 admin，则显示密钥框
  if (roleSelect && roleSelect.value === 'admin') {
    secretGroup.style.display = 'block';
    // 添加一个小动画效果
    secretGroup.style.opacity = '0';
    setTimeout(() => {
        secretGroup.style.transition = 'opacity 0.3s ease';
        secretGroup.style.opacity = '1';
    }, 10);
  } else {
    secretGroup.style.display = 'none';
  }
}

// 页面加载时运行一次，防止表单验证失败回显时状态不对
document.addEventListener('DOMContentLoaded', toggleSecretKey);
</script>
{% endblock %}