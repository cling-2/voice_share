{% extends "layout.html" %}
{% block title %}房间 {{ room.code }}{% endblock %}

{% block content %}
<section class="grid-card room-header" data-room="{{ room.code }}">
  <div class="room-header-info">
    <h1>{{ room.name }} · {{ room.code }}</h1>
    <p>房间类型：私密 · 主控：{{ room.owner.nickname or room.owner.username }}</p>
    <p>房间状态：
      <span id="room-status" class="status-badge {{ 'active' if room.is_active else 'closed' }}">
        {{ '开放' if room.is_active else '已关闭' }}
      </span>
      <small>房间号可重复使用，除非房主主动关闭</small>
    </p>
  </div>
  <div class="room-header-actions">
    {% if is_owner %}
      <form method="post" action="{{ url_for('main.room_availability', code=room.code) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="action" value="{{ 'close' if room.is_active else 'open' }}" />
        <button type="submit" class="{{ 'secondary-btn' if room.is_active else 'primary-btn' }}">
          {{ '关闭房间' if room.is_active else '重新开放' }}
        </button>
      </form>
      <form method="post" action="{{ url_for('main.delete_room', code=room.code) }}" onsubmit="return confirm('确认删除该房间？房间号将不可再使用。');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit" class="danger-btn">删除房间</button>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('main.leave_room', code=room.code) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit" class="secondary-btn">退出房间</button>
      </form>
    {% endif %}
  </div>
</section>

{% if not room.is_active %}
  <div class="room-alert">
    房间已关闭，仅房主可查看和管理。好友需要房主重新开放后才能再次进入。
  </div>
{% endif %}

<section class="grid-card now-playing-card">
  <div class="now-playing-content">
    <div class="playing-label">正在播放</div>
    <h1 class="current-track-title" id="current-track-label">
        {% if room.current_track_name %}{{ room.current_track_name }}{% else %}暂无播放{% endif %}
    </h1>
    <div class="playback-status-badge">
        状态：<span id="state-label">{{ '播放中' if room.playback_status == 'playing' else '已暂停' }}</span>
    </div>
  </div>

  <div class="audio-controller">
      <audio id="room-audio" controls preload="auto" class="full-width-audio">
        {% if room.current_track_file %}
          <source src="{{ url_for('static', filename='uploads/music/' + room.current_track_file) }}" type="audio/mpeg" />
        {% endif %}
        您的浏览器不支持音频播放
      </audio>
      {% if is_owner %}
        <div class="host-controls">
            <form method="post" action="{{ url_for('main.toggle_playback', code=room.code) }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                {% if room.playback_status == 'playing' %}
                    <button class="secondary-btn" name="action" value="pause">暂停全员</button>
                {% else %}
                    <button class="primary-btn" name="action" value="play">播放全员</button>
                {% endif %}
            </form>
        </div>
      {% else %}
        <p class="hint-text">你可以自由调整本地进度，但切歌和暂停由房主控制。</p>
      {% endif %}
  </div>
</section>

<section class="grid-card">
  <div class="room-flex">
    <div class="player-panel">
      <h2>房间播放列表</h2>
      <p class="subtitle">房主可点击播放，所有成员可从下方个人库添加</p>
      <div class="playlist-container">
        <table class="data-table playlist-table">
            <thead>
                <tr>
                    <th>歌曲</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for item in room_playlist %}
                <tr class="{{ 'active-row' if item.music.title == room.current_track_name else '' }}">
                    <td>{{ item.music.title }}</td>
                    <td>
                        {% if is_owner %}
                            <form method="post" action="{{ url_for('main.toggle_playback', code=room.code) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="music_id" value="{{ item.music.id }}" />
                                <button type="submit" class="small-btn primary-btn">播放</button>
                            </form>
                        {% else %}
                            <span class="muted">仅房主可切歌</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="2" class="muted">列表为空，请从下方添加</td></tr>
                {% endfor %}
            </tbody>
        </table>
      </div>

      <div class="my-library-panel">
          <h3>从我的音乐库添加</h3>
          <div class="scroll-list">
              {% for music in my_library %}
                <div class="library-item">
                    <span class="music-name">{{ music.title }}</span>
                    <form method="post" action="{{ url_for('main.add_to_playlist', code=room.code) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="music_id" value="{{ music.id }}" />
                        <button type="submit" class="small-btn secondary-btn">添加</button>
                    </form>
                </div>
              {% else %}
                <p class="muted">你的库中没有已过审音乐，请去“我的音乐”上传。</p>
              {% endfor %}
          </div>
      </div>
    </div>

    <div class="chat-panel">
      <h2>房间评论</h2>
      <div class="chat-log" id="chat-log">
        {% for message in messages %}
          <div class="chat-item">
            <img src="{{ message.author.avatar_url }}" alt="avatar" class="chat-avatar" />
            <div class="chat-item-content">
              <strong>{{ message.author.nickname or message.author.username }}</strong>
              <span>{{ message.created_at.strftime('%H:%M:%S') }}</span>
              <p>{{ message.content }}</p>
            </div>
          </div>
        {% else %}
          <p>暂时没有评论</p>
        {% endfor %}
      </div>
      <form method="post" action="{{ url_for('main.send_message', code=room.code) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <textarea name="content" class="input" rows="3" placeholder="说点什么吧"></textarea>
        <button class="primary-btn" type="submit">发送评论</button>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block body_extra %}
<script>
  window.roomConfig = {
    code: "{{ room.code }}",
    isOwner: {{ 'true' if is_owner else 'false' }},
    isActive: {{ 'true' if room.is_active else 'false' }},
    audioSelector: "#room-audio",
    stateUrl: "{{ url_for('main.room_state', code=room.code) }}"
  };
</script>
{% endblock %}